#include "bhop.hpp"

#include "../sdk/csgostructs.hpp"

void BunnyHop::OnCreateMove(CUserCmd* cmd)
{
    static bool jumped_last_tick = false;
    static bool should_fake_jump = false;

    if (!g_LocalPlayer)
        return;

    if (!g_LocalPlayer->IsAlive())
        return;

    if (g_LocalPlayer->m_nMoveType() == MOVETYPE_LADDER || g_LocalPlayer->m_nMoveType() == MOVETYPE_NOCLIP)
        return;

    if (g_LocalPlayer->m_fFlags() & FL_INWATER)
        return;

    if (!jumped_last_tick && should_fake_jump) 
    {
        should_fake_jump = false;
        cmd->buttons |= IN_JUMP;
    }
    else if (cmd->buttons & IN_JUMP) 
    {
        if (g_LocalPlayer->m_fFlags() & FL_ONGROUND) 
        {
            jumped_last_tick = true;
            should_fake_jump = true;
        }
        else 
        {
            cmd->buttons &= ~IN_JUMP;
            jumped_last_tick = false;
        }
    }
    else 
    {
        jumped_last_tick = false;
        should_fake_jump = false;
    }
}